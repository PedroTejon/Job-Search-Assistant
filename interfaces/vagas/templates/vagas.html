{% load static %}

{% include "start.html" %}
    <div id="listings_section">
        <div id="listings_filters">
            <div id="search_bar_container">
                <input id="search_bar" type="text" value="{{query}}">
                <button id="search_button" onclick="search('{{query}}')"><img src="{% static 'magnifying-glass.svg' %}" width="16" height="16"></button>
            </div>

            <div style="grid-column: 2;">
                <button id="filter_menu_button" onclick="show_filter_menu()"><img src="{% static 'filter.svg' %}" width="16" height="16"></button>
            </div>

            <div id="extraction_section">
                <div id="extraction_results"></div>
                <div id="progress_bar_overall" class="progress_bar_container" onclick="show_extraction_progress_menu()">
                    <div class="extraction_progress_bar">
                        <div class="extraction_progress_bar_value"></div>
                    </div>
                </div>
                <button id="extract_button" onclick="extract_listings()"><img src="{% static 'plus.svg' %}" width="16" height="16"></button> 
                <div id="extraction_progress_menu">
                    <span id="new_listings_linkedin" style="grid-column: 1; justify-self: center"></span>
                    <div id="progress_linkedin" class="progress_bar_container" style="width: 8vw; grid-column: 2;">
                        <div class="extraction_progress_bar">
                            <div class="extraction_progress_bar_value"></div>
                        </div>
                    </div>
                    <img src="{% static 'linkedin.svg' %}" width="16" height="16" style="grid-column: 3; font-size: 24px;">

                    <span id="new_listings_glassdoor" style="grid-column: 1; justify-self: center"></span>
                    <div id="progress_glassdoor" class="progress_bar_container" style="width: 8vw; grid-column: 2;">
                        <div class="extraction_progress_bar">
                            <div class="extraction_progress_bar_value"></div>
                        </div>
                    </div>
                    <img src="{% static 'glassdoor.svg' %}" width="16" height="16" style="grid-column: 3; font-size: 24px; align-self: center;"></i>

                    <span id="new_listings_catho" style="grid-column: 1; justify-self: center"></span>
                    <div id="progress_catho" class="progress_bar_container" style="width: 8vw; grid-column: 2;">
                        <div class="extraction_progress_bar">
                            <div class="extraction_progress_bar_value"></div>
                        </div>
                    </div>
                    <img src="{% static 'catho.svg' %}" width="16" height="16" style="grid-column: 3; font-size: 24px; align-self: center;"></i>

                    <span id="new_listings_vagas_com" style="grid-column: 1; justify-self: center;"></span>
                    <div id="progress_vagas_com" class="progress_bar_container" style="width: 8vw; grid-column: 2;">
                        <div class="extraction_progress_bar">
                            <div class="extraction_progress_bar_value"></div>
                        </div>
                    </div>
                    <img src="{% static 'vagas.com.svg' %}" width="16" height="16" style="grid-column: 3; font-size: 24px; align-self: center"></i>
                </div>
            </div>
        </div>
        <div id="listings_view">
            <div id="highlight_tools" style="display: none;">
                <button id="filter_word_button" title="Proibir palavra única" onclick="apply_new_filter('exclude_words')"><img src="{% static 'underline.svg' %}" width="16" height="16"></button>
                <button id="filter_term_button" title="Proibir termo/sequência de caracteres" onclick="apply_new_filter('exclude_terms')"><img src="{% static 'highlighter.svg' %}" width="16" height="16"></button>
            </div>
            <div id="listings_sidebar" {% if listing_count == 0 %}style="display:flex;flex-direction:column;justify-content:space-between"{% endif %}>
                
                <div id="querying_filter_menu">
                    <span>Filtrar por:</span>
                    <details class="filter_section" open>
                        <summary>Vaga</summary>
                        <label for="query_new">Vagas não avaliadas:</label>
                        <input id="query_new" type="checkbox" {{ listing_properties.2 | yesno:"checked," }}>
                        <br>
                        <label for="query_applied">Vagas inscritas:</label>
                        <input id="query_applied" type="checkbox" {{ listing_properties.0 | yesno:"checked," }}>
                        <br>
                        <label for="query_dismissed">Vagas dispensadas:</label>
                        <input id="query_dismissed" type="checkbox" {{ listing_properties.1 | yesno:"checked," }}>
                        <br>
                        <label for="query_local_listings">Vagas presenciais/híbridas:</label>
                        <input id="query_local_listings" type="checkbox" {{ listing_properties.3 | yesno:"checked," }}>
                        <br>
                        <label for="query_remote_listings">Vagas remotas:</label>
                        <input id="query_remote_listings" type="checkbox" {{ listing_properties.4 | yesno:"checked," }}>
                    </details>
                    <details class="filter_section" open>
                        <summary>Empresas:</summary>
                        <input id="query_company_input" type="text" placeholder="Termo presente no nome" style="width: 85%">
                        <div id="query_company_container" class="query_multivalue_container">
                            {% for company in companies %}
                                <span class="query_multivalue_option" onclick="remove_company('{{ company }}')">{{ company }}</span>
                            {% endfor %}
                        </div>
                    </details>
                    <details class="filter_section" open>
                        <summary>Cidades:</summary>
                        <input id="query_city_input" type="text" placeholder="Nome da cidade" style="width: 85%">
                        <div id="query_city_container" class="query_multivalue_container">
                            {% for city in cities %}
                                <span class="query_multivalue_option" onclick="remove_city('{{ city }}')">{{ city }}</span>
                            {% endfor %}
                        </div>
                    </details>
                    <details class="filter_section" open>
                        <summary>Plataformas:</summary>
                        <select id="query_platform_input" style="width: 85%">
                            <option value="-">-</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Glassdoor">Glassdoor</option>
                            <option value="Catho">Catho</option>
                            <option value="Vagas.com">Vagas.com</option>
                        </select>
                        <div id="query_platform_container" class="query_multivalue_container">
                            {% for platform in platforms %}
                                <span class="query_multivalue_option" onclick="remove_platform('{{ platform }}')">{{ platform }}</span>
                            {% endfor %}
                        </div>
                    </details>
                </div>
                {% for listing in listings %}
                    <div class="listing" id="listing_{{forloop.counter0}}" onclick="show({{forloop.counter0}})">
                        <p class="listing_title">{{listing.title}}</p>
                        <p class="listing_company">{{listing.company_name}}</p>
                        {% if listing.workplace_type != 'Remoto' %}
                            <p class="listing_condition">{{listing.location}}</p>
                        {% else %}
                            <p class="listing_condition">Remoto</p>
                        {% endif %}
                            <div class="icon_container">
                            {% if listing.applied %}
                                <img class="listing_status" src="{% static 'check.svg' %}" width="16" height="16">
                            {% elif not listing.applied and listing.applied is not None %}
                                <img class="listing_status" src="{% static 'x.svg' %}" width="16" height="16">
                            {% else %}
                                <img class="listing_status" src="{% static 'transparent.svg' %}" width="16" height="16">
                            {% endif %}
                            {% if listing.workplace_type != 'Remoto' %}
                                <img src="{% static 'briefcase.svg' %}" width="16" height="16">
                            {% else %}
                                <img src="{% static 'laptop.svg' %}" width="16" height="16">
                            {% endif %}
                            {% if listing.platform == 'Glassdoor' %}
                                <img src="{% static 'glassdoor.svg' %}" width="16" height="16" title="Vaga postada no Glassdoor">
                            {% elif listing.platform == 'LinkedIn' %}
                                <img src="{% static 'linkedin.svg' %}" width="16" height="16" title="Vaga postada no LinkedIn">
                            {% elif listing.platform == 'Catho' %}
                                <img src="{% static 'catho.svg' %}" width="16" height="16" title="Vaga postada na Catho">
                            {% elif listing.platform == 'Vagas.com' %}
                                <img src="{% static 'vagas.com.svg' %}" width="16" height="16" title="Vaga postada no Vagas.com">
                            {% endif %} 
                        </div>
                    </div>
                {% endfor %}
                {% if listing_count == 0 %}<br>{% endif %}
                <div id="listings_pagination">
                    {% if page != 1 and 1 not in pages %}
                        {% if query %}
                            <a href="http://localhost:8000/vagas/?page=1&query={{query}}"> 1 </a> ...
                        {% else %}
                            <a href="http://localhost:8000/vagas/?page=1"> 1 </a> ...
                        {% endif %}
                    {% endif %}

                    {% for num_page in pages %}
                        {% if num_page == page %}
                            {% if query %}
                                <a href="http://localhost:8000/vagas/?page={{num_page}}&query={{query}}"><b>{{num_page}}</b></a> 
                            {% else %}
                                <a href="http://localhost:8000/vagas/?page={{num_page}}"><b>{{num_page}}</b></a> 
                            {% endif %}
                        {% else %}
                            {% if query %}
                                <a href="http://localhost:8000/vagas/?page={{num_page}}&query={{query}}">{{num_page}}</a> 
                            {% else %}
                                <a href="http://localhost:8000/vagas/?page={{num_page}}">{{num_page}}</a> 
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if page != total_pages and total_pages not in pages and page < total_pages %}
                        {% if query %}
                        ... <a href="http://localhost:8000/vagas/?page={{total_pages}}&query={{query}}"> {{total_pages}}</a>
                        {% else %}
                        ... <a href="http://localhost:8000/vagas/?page={{total_pages}}"> {{total_pages}}</a>
                        {% endif %}
                    
                    {% endif %}
                </div>
            </div>
            <div id="listing_details" style="display: none"> 
                <div style="width:auto; height: auto; display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                    <div style="width: auto; height: auto;">
                        <p id="listing_title_det"></p>
                        <p id="platform_id"></p>
                        <div style="display: flex; flex-direction: row; column-gap: 1vw;">
                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img src="{% static 'building.svg' %}" width="16" height="16" title="Empresa que publicou a vaga">
                                <p id="listing_company_det"></p>
                            </div>
                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img src="{% static 'location-dot.svg' %}" width="16" height="16" title="Local de trabalho">
                                <p id="listing_location_det"></p>
                            </div>
                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img id="listing_workplace_type_ico" width="16" height="16" title="Vaga presencial/híbrida">
                                <p id="listing_workplace_type_det"></p>
                            </div>
                            
                        </div>
                        <div style="display: flex; flex-direction: row; column-gap: 1vw;">
                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img id="platform_logo" width="16" height="16">
                                <p id="platform_name"></p>
                            </div>

                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img src="{% static 'calendar.svg' %}" width="16" height="16"  title="Data de publicação da vaga">
                                <p id="listing_publish_date_det"></p>
                            </div>
                            <div style="display: flex; flex-direction: row; column-gap: 0.5vw;">
                                <img src="{% static 'users.svg' %}" width="16" height="16" title="Candidatos inscritos na vaga">
                                <p id="listing_applies_det"></p>
                            </div>
                        </div>
                    </div>
                    <div id="apply_section">
                        <a id="apply_button" target="_blank">Candidatar-se</a>
                        <button id="applied_button" onclick="applied_to_listing()"><img style="filter: invert(100%)" class="listing_status" src="{% static 'check.svg' %}" width="16" height="16"></button>
                        <button id="dismissed_button" onclick="dismiss_listing()"><img style="filter: invert(100%)" class="listing_status" src="{% static 'x.svg' %}" width="16" height="16"></button>
                    </div>
                </div>
                <br>    
                <hr>
                <br>
                <p id="listing_description_det"></p>
            </div>
        </div>
    </div>
    
    {{listings|json_script:"listings"}}
    {{companies|json_script:"queried_companies"}}
    {{cities|json_script:"queried_cities"}}
    {{platforms|json_script:"queried_platforms"}}
    <script defer>
        listings = JSON.parse(document.getElementById('listings').textContent);
        get_listings_extraction_status()
        if (listings.length > 0) {
            show(0);

            for (let i = 0; i < listings.length; i++) {
                let listing_status = document.querySelector(`#listing_${i} .listing_status`)
                let current_listing = listings[i];
                if (current_listing.applied_to)
                    listing_status.src = 'http://localhost:8000/static/check.svg'
                else if (current_listing.applied_to === false)
                    listing_status.src = 'http://localhost:8000/static/x.svg'
                else
                    listing_status.src = 'http://localhost:8000/static/transparent.svg'
            }
        }
                
        let queried_companies = JSON.parse(document.getElementById('queried_companies').textContent);
        let queried_cities = JSON.parse(document.getElementById('queried_cities').textContent);
        let queried_platforms = JSON.parse(document.getElementById('queried_platforms').textContent);
        
        let query_company_input = document.getElementById('query_company_input')
        query_company_input.addEventListener('keydown', function (e) {
            if (e.code === 'Enter') {
                let queried_company = query_company_input.value.trim()
                query_company_input.value = ''
                if (queried_company !== '' && !queried_companies.includes(queried_company)) {
                    queried_companies.push(queried_company)
                    
                    document.getElementById('query_company_container').innerHTML += `<span class="query_multivalue_option" onclick="remove_company('${queried_company}')">${queried_company}</span>`
                }
            }
        });

        let query_city_input = document.getElementById('query_city_input')
        query_city_input.addEventListener('keydown', function (e) {
            if (e.code === 'Enter') {
                let queried_city = query_city_input.value.trim()
                query_city_input.value = ''
                if (queried_city !== '' && !queried_cities.includes(queried_city)) {
                    queried_cities.push(queried_city)
                    document.getElementById('query_city_container').innerHTML += `<span class="query_multivalue_option" onclick="remove_city('${queried_city}')">${queried_city}</span>`
                }
            }
        });

        let query_platform_input = document.getElementById('query_platform_input')
        query_platform_input.addEventListener('change', function (e) {
            let queried_platform = query_platform_input.value
            query_platform_input.value = '-'
            if (queried_platform !== '-' && !queried_platforms.includes(queried_platform)) {
                queried_platforms.push(queried_platform)
                document.getElementById('query_platform_container').innerHTML += `<span class="query_multivalue_option" onclick="remove_platform('${queried_platform}')">${queried_platform}</span>`
            }
            
        });

        let search_bar = document.getElementById('search_bar')
        search_bar.addEventListener('keydown', function (e) {
            if (e.code === 'Enter') {
                search(search_bar.value)
            }
        });
    </script>
{% include "end.html" %}